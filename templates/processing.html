{% extends "base.html" %}

{% block title %}Przetwarzanie danych{% endblock %}

{% block container_class %}fluid-container{% endblock %}

{% block head %}
<style>
    .card {
        margin: 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
        max-width: 100%;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .preview-table {
        width: 100%;
        overflow-x: auto;
    }
    
    .preview-table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .progress-details {
        font-size: 0.9rem;
        color: var(--medium-gray);
        margin-top: 5px;
    }
    
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .status-message {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-weight: 500;
    }
    
    .status-processing {
        background-color: #e3f2fd;
        color: #0d47a1;
        border-left: 4px solid #2196f3;
    }
    
    .status-complete {
        background-color: #e8f5e9;
        color: #1b5e20;
        border-left: 4px solid #4caf50;
    }
    
    .status-error {
        background-color: #ffebee;
        color: #b71c1c;
        border-left: 4px solid #f44336;
    }
    
    .data-table {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
    }
    
    .data-table table {
        width: 100%;
        table-layout: auto;
    }
    
    .data-table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        box-shadow: 0 1px 0 var(--border-color);
        white-space: normal;
        word-wrap: break-word;
        padding: 6px 8px;
        font-size: 0.75rem;
        max-width: 120px;
        vertical-align: top;
        text-align: center;
        line-height: 1.2;
    }
    
    .data-table td {
        padding: 6px 8px;
        font-size: 0.75rem;
        vertical-align: middle;
    }
    
    .pulse {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Poprawki dla pełnego ekranu */
    html, body {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .container {
        width: 100%;
        max-width: 100%;
        padding-left: 0;
        padding-right: 0;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    /* Style dla niezgeokodowanych wierszy */
    .ungeocoded-row {
        background-color: #fff3e0;
    }
    
    .ungeocoded-row td {
        color: #e65100;
    }
    
    .ungeocoded-badge {
        display: inline-block;
        padding: 2px 6px;
        background-color: #ff9800;
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-left: 5px;
    }
    
    .error-message {
        color: #e65100;
        font-size: 0.85rem;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <i class="fas fa-cogs"></i> Przetwarzanie danych
        </div>
        <div>
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Powrót
            </a>
        </div>
    </div>
    <div class="card-body">
        <div id="status-container" class="status-message status-processing">
            <div class="spinner"></div>
            {% if processing_type == "geocoding" %}
                Trwa sprawdzanie lokalizacji...
            {% else %}
                Przetwarzanie danych...
            {% endif %}
            <span>Trwa przetwarzanie danych...</span>
        </div>
        
        <div id="matrix-info" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle"></i> <span id="matrix-text">Używana macierz marży będzie wyświetlona tutaj</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-label">
                <span>Postęp przetwarzania</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="progress-details">
                <span id="progress-details">Wczytywanie danych...</span>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-label">
                <span>Geokodowanie</span>
                <span id="geocoding-percentage">0%</span>
            </div>
            <div class="progress">
                <div id="geocoding-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
        
        <div id="download-container" style="display: none;" class="text-center mt-3 mb-3">
            <a id="download-link" href="/download" class="btn btn-success">
                <i class="fas fa-download"></i> Pobierz wyniki
            </a>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-table"></i> Podgląd wyników
            </div>
            <div class="card-body p-0">
                <div class="data-table">
                    <table class="table mb-0">
                        <thead>
                            <tr id="preview-headers">
                                <!-- Nagłówki będą wstawione przez JavaScript -->
                            </tr>
                        </thead>
                        <tbody id="preview-data">
                            <!-- Dane będą wstawione przez JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Funkcja formatująca liczby jako liczby całkowite
    function formatInteger(value) {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
            return Math.round(value).toLocaleString('pl-PL');
        }
        return value;
    }

    // Funkcja formatująca liczby z dwoma miejscami po przecinku
    function formatNumber(value) {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
            return value.toLocaleString('pl-PL', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value;
    }

    // Funkcja aktualizująca pasek postępu i szczegóły
    function updateProgress(progress, current, total) {
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const progressDetails = document.getElementById('progress-details');
        
        progressBar.style.width = progress + '%';
        progressPercentage.textContent = progress + '%';
        
        if (progress >= 0 && current >= 0 && total > 0) {
            progressDetails.textContent = `Przetworzono ${current} z ${total} wierszy`;
        } else if (progress === 100) {
            progressDetails.textContent = 'Przetwarzanie zakończone!';
        } else if (progress < 0) {
            progressDetails.textContent = 'Wystąpił błąd podczas przetwarzania';
            progressBar.style.backgroundColor = 'var(--danger-color)';
        }
    }

    // Funkcja aktualizująca pasek postępu geokodowania
    function updateGeocodingProgress(progress) {
        const geocodingBar = document.getElementById('geocoding-bar');
        const geocodingPercentage = document.getElementById('geocoding-percentage');
        
        geocodingBar.style.width = progress + '%';
        geocodingPercentage.textContent = progress + '%';
    }

    // Funkcja aktualizująca tabelę podglądu
    function updatePreviewTable(data) {
        const headers = document.getElementById('preview-headers');
        const tbody = document.getElementById('preview-data');
        
        // Aktualizuj nagłówki - używamy bezpośrednio nagłówków z danych i dodajemy regionalne
        if (data.preview_data.headers && data.preview_data.headers.length > 0) {
            const customHeaders = [...data.preview_data.headers];
            // Dodajemy kolumny regionalne przed kolumnami z marżą (przed ostatnimi 2 kolumnami)
            customHeaders.splice(-2, 0, 'Stawka Region - Region 3/6/12m Klient');
            customHeaders.splice(-2, 0, 'Stawka Region - Region 3/6/12m Giełda');
            
            headers.innerHTML = customHeaders
                .map(header => `<th>${header}</th>`)
                .join('');
        }
        
        // Aktualizuj dane
        tbody.innerHTML = data.preview_data.rows
            .map(row => {
                // Sprawdź czy wiersz jest zgeokodowany
                const isGeocoded = row['Dystans (km)'] !== null && row['Dystans (km)'] !== undefined;
                
                // Pobierz wszystkie stawki regionalne z danych
                const getAllRegionalRates = (row, type) => {
                    const rate3m = row[`Region - ${type} stawka 3m`];
                    const rate6m = row[`Region - ${type} stawka 6m`];
                    const rate12m = row[`Region - ${type} stawka 12m`];
                    
                    return {
                        rate3m: rate3m,
                        rate6m: rate6m,
                        rate12m: rate12m
                    };
                };

                const regionKlientRates = getAllRegionalRates(row, 'Klient');
                const regionGieldaRates = getAllRegionalRates(row, 'Giełda');

                const formatAllRegionalRates = (rates) => {
                    const format3m = (rates.rate3m !== null && rates.rate3m !== undefined && typeof rates.rate3m === 'number') ? 
                        `${formatNumber(rates.rate3m)}€` : '-';
                    const format6m = (rates.rate6m !== null && rates.rate6m !== undefined && typeof rates.rate6m === 'number') ? 
                        `${formatNumber(rates.rate6m)}€` : '-';
                    const format12m = (rates.rate12m !== null && rates.rate12m !== undefined && typeof rates.rate12m === 'number') ? 
                        `${formatNumber(rates.rate12m)}€` : '-';
                    
                    // Sprawdź czy wszystkie są puste
                    if (format3m === '-' && format6m === '-' && format12m === '-') {
                        return '-';
                    }
                    
                    return `${format3m} / ${format6m} / ${format12m}`;
                };
                
                // Formatowanie sugerowanego frachtu
                const formatSuggestedRate = (row) => {
                    if (row['Sugerowany fracht wg historycznych stawek'] !== null && row['Sugerowany fracht wg historycznych stawek'] !== undefined) {
                        const period = row['Sugerowany fracht okres'] || '3m';  // Domyślnie 3m jeśli brak okresu
                        return `${formatInteger(row['Sugerowany fracht wg historycznych stawek'])}€/km (${period})`;
                    }
                    return '-';
                };
                
                // Przygotuj komunikat o błędzie dla niezgeokodowanych lokalizacji
                const errorMessage = !isGeocoded ? 
                    '<div class="error-message">Nie można obliczyć kosztów - lokalizacja nie została zgeokodowana</div>' : '';
                
                return `
                <tr class="${!isGeocoded ? 'ungeocoded-row' : ''}">
                    <td>
                        ${row['Kraj załadunku'] || '-'}
                        ${!isGeocoded ? '<span class="ungeocoded-badge">Niezgeokodowane</span>' : ''}
                    </td>
                    <td>${row['Kod pocztowy załadunku'] || '-'}</td>
                    <td>${row['Kraj rozładunku'] || '-'}</td>
                    <td>${row['Kod pocztowy rozładunku'] || '-'}</td>
                    <td>
                        ${formatInteger(row['Dystans (km)'])}
                        ${errorMessage}
                    </td>
                    <td>${formatInteger(row['Podlot (km)'])}</td>
                    <td>${formatNumber(row['Koszt paliwa'])}${row['Koszt paliwa'] ? '€' : ''}</td>
                    <td>${formatNumber(row['Opłaty drogowe'])}${row['Opłaty drogowe'] ? '€' : ''}</td>
                    <td>${formatInteger(row['Koszt kierowcy + leasing'])}${row['Koszt kierowcy + leasing'] ? '€' : ''}</td>
                    <td>${formatNumber(row['Koszt podlotu (opłaty + paliwo)'])}${row['Koszt podlotu (opłaty + paliwo)'] ? '€' : ''}</td>
                    <td>${formatNumber(row['Opłaty/km'])}${row['Opłaty/km'] ? '€/km' : ''}</td>
                    <td style="white-space: pre-line">${row['Opłaty drogowe (szczegóły)'] || '-'}</td>
                    <td>${formatInteger(row['Suma kosztów'])}${row['Suma kosztów'] ? '€' : ''}</td>
                    <td>
                        ${row['Link do mapy'] ? 
                            `<a href="${row['Link do mapy']}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-map-marked-alt"></i> Mapa
                            </a>` : '-'}
                    </td>
                    <td>${formatSuggestedRate(row)}</td>
                    <td>${formatInteger(row['Sugerowany fracht wg matrixa'])}${row['Sugerowany fracht wg matrixa'] ? '€' : ''}</td>
                    <td style="white-space: nowrap;">${formatAllRegionalRates(regionKlientRates)}</td>
                    <td style="white-space: nowrap;">${formatAllRegionalRates(regionGieldaRates)}</td>
                    <td>${formatInteger(row['Oczekiwany zysk'])}${row['Oczekiwany zysk'] ? '€' : ''}</td>
                    <td>${formatNumber(row['Transit time (dni)']) || '-'}</td>
                </tr>
            `})
            .join('');
    }

    // Funkcja sprawdzająca postęp przetwarzania
    function checkProgress() {
        // Sprawdź typ przetwarzania i wybierz odpowiedni endpoint
        const progressEndpoint = '{{ processing_type }}' === 'geocoding' ? '/geocoding_progress' : '/progress';
        
        fetch(progressEndpoint)
            .then(response => response.json())
            .then(data => {
                // Dla geokodowania
                if ('{{ processing_type }}' === 'geocoding') {
                    // Aktualizuj pasek postępu geokodowania
                    updateProgress(data.progress, data.current, data.total);
                    
                    const statusContainer = document.getElementById('status-container');
                    
                    if (data.status === 'completed') {
                        statusContainer.className = 'status-message status-complete';
                        statusContainer.innerHTML = '<i class="fas fa-check-circle"></i> Sprawdzanie lokalizacji zakończone pomyślnie!';
                        
                        // Przekieruj do wyników
                        setTimeout(() => {
                            window.location.href = '/ungeocoded_locations';
                        }, 1500);
                        
                        return; // Zakończ sprawdzanie postępu
                    } else if (data.status === 'running') {
                        statusContainer.innerHTML = `
                            <div class="spinner"></div>
                            Sprawdzanie lokalizacji: ${data.current} z ${data.total}
                        `;
                    }
                } else {
                    // Standardowe przetwarzanie przetargów
                    // Aktualizuj pasek postępu
                    updateProgress(data.progress, data.current, data.total);
                    
                    // Aktualizuj pasek postępu geokodowania
                    updateGeocodingProgress(data.geocoding_progress);
                    
                    // Aktualizuj informację o macierzy
                    if (data.matrix_name) {
                        const matrixInfo = document.getElementById('matrix-info');
                        const matrixText = document.getElementById('matrix-text');
                        matrixText.textContent = `Używana macierz marży: ${data.matrix_name}`;
                        matrixInfo.style.display = 'block';
                    }
                    
                    // Aktualizuj tabelę podglądu
                    if (data.preview_data && data.preview_data.rows) {
                        updatePreviewTable(data);
                    }
                    
                    // Aktualizuj status
                    const statusContainer = document.getElementById('status-container');
                    const downloadContainer = document.getElementById('download-container');
                    
                    if (data.processing_complete) {
                        if (data.error) {
                            statusContainer.className = 'status-message status-error';
                            statusContainer.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Wystąpił błąd podczas przetwarzania danych.';
                        } else {
                            statusContainer.className = 'status-message status-complete';
                            statusContainer.innerHTML = '<i class="fas fa-check-circle"></i> Przetwarzanie zakończone pomyślnie!';
                            downloadContainer.style.display = 'block';
                        }
                        return; // Zakończ sprawdzanie postępu
                    }
                }
                
                // Kontynuuj sprawdzanie postępu co 1 sekundę
                setTimeout(checkProgress, 1000);
            })
            .catch(error => {
                console.error('Błąd podczas sprawdzania postępu:', error);
                setTimeout(checkProgress, 2000); // Ponów próbę po 2 sekundach
            });
    }

    // Rozpocznij sprawdzanie postępu po załadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        checkProgress();
    });
</script>
{% endblock %} 