{% extends "base.html" %}

{% block title %}Test pojedynczej trasy{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <i class="fas fa-route"></i> Wycena pojedynczej trasy
        </div>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Wprowadź dane dla jednej trasy, aby przetestować wyliczenie dystansu i kosztów.
        </div>

        <form method="post" action="/test_route_form">
            <div class="form-group mb-4">
                <label for="matrix_type" class="form-label">Matrix marży na dzień:</label>
                <select name="matrix_type" id="matrix_type" class="form-control" required>
                    <option value="klient" selected>Matrix Klient</option>
                    <option value="targi">Matrix Targi</option>
                </select>
                <small class="form-text text-muted">Wybierz typ matrixa do obliczeń oczekiwanego zysku</small>
            </div>

            <div class="form-group mb-4">
                <label for="transit_time" class="form-label">Transit time (dni) - opcjonalne:</label>
                <input type="number" id="transit_time" name="transit_time" class="form-control" min="0.25" max="30" step="0.25" placeholder="np. 2.5">
                <small class="form-text text-muted">Jeśli nie podasz, zostanie obliczone automatycznie na podstawie dystansu</small>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="fuel_cost" class="form-label">Koszt paliwa (€/km):</label>
                        <input type="number" id="fuel_cost" name="fuel_cost" class="form-control" 
                               min="0" max="5" step="0.01" value="0.40" required>
                        <small class="form-text text-muted">Domyślnie: 0.40 €/km (27l/100km × 1.50€/l)</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="driver_cost" class="form-label">Koszt kierowcy + leasing (€/dzień):</label>
                        <input type="number" id="driver_cost" name="driver_cost" class="form-control" 
                               min="0" max="1000" step="1" value="210" required>
                        <small class="form-text text-muted">Domyślnie: 210 €/dzień</small>
                    </div>
                </div>
            </div>

            <div class="d-flex">
                <div style="flex: 1; margin-right: 15px;">
                    <h5 class="mb-3">Punkt załadunku</h5>
                    
                    <div class="form-group">
                        <label for="load_country" class="form-label">Kraj załadunku:</label>
                        <input type="text" id="load_country" name="load_country" class="form-control" required placeholder="np. PL, DE, FR">
                    </div>
                    
                    <div class="form-group">
                        <label for="load_postal" class="form-label">Kod pocztowy załadunku:</label>
                        <input type="text" id="load_postal" name="load_postal" class="form-control" required placeholder="np. 00-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="load_city" class="form-label">Miasto załadunku (opcjonalne):</label>
                        <input type="text" id="load_city" name="load_city" class="form-control" placeholder="np. Warszawa">
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <h5 class="mb-3">Punkt rozładunku</h5>
                    
                    <div class="form-group">
                        <label for="unload_country" class="form-label">Kraj rozładunku:</label>
                        <input type="text" id="unload_country" name="unload_country" class="form-control" required placeholder="np. PL, DE, FR">
                    </div>
                    
                    <div class="form-group">
                        <label for="unload_postal" class="form-label">Kod pocztowy rozładunku:</label>
                        <input type="text" id="unload_postal" name="unload_postal" class="form-control" required placeholder="np. 00-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="unload_city" class="form-label">Miasto rozładunku (opcjonalne):</label>
                        <input type="text" id="unload_city" name="unload_city" class="form-control" placeholder="np. Berlin">
                    </div>
                </div>
            </div>
            
            <!-- ========== NOWA SEKCJA: PUNKTY POŚREDNIE ========== -->
            <div class="card mt-4 mb-4" style="border: 2px dashed #007bff;">
                <div class="card-header" style="background-color: #e7f3ff;">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt"></i> Punkty pośrednie (opcjonalnie)
                    </h5>
                    <small class="text-muted">Dodaj do 5 punktów, przez które ma przejść trasa</small>
                </div>
                <div class="card-body">
                    <div id="waypoints-container">
                        <!-- Punkty pośrednie będą dodawane dynamicznie przez JavaScript -->
                    </div>
                    
                    <button type="button" id="add-waypoint-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus-circle"></i> Dodaj punkt pośredni
                    </button>
                    
                    <div class="alert alert-info mt-3" id="waypoints-help">
                        <i class="fas fa-info-circle"></i>
                        Kliknij "Dodaj punkt pośredni", aby dodać przystanki na trasie.
                        Kolejność punktów ma znaczenie!
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3">
                <i class="fas fa-calculator"></i> Oblicz trasę
            </button>
        </form>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <i class="fas fa-info-circle"></i> Dostępne kody krajów
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <ul class="list-unstyled">
                    <li><strong>PL</strong> - Polska</li>
                    <li><strong>DE</strong> - Niemcy</li>
                    <li><strong>FR</strong> - Francja</li>
                    <li><strong>IT</strong> - Włochy</li>
                    <li><strong>ES</strong> - Hiszpania</li>
                </ul>
            </div>
            <div class="col-md-4">
                <ul class="list-unstyled">
                    <li><strong>NL</strong> - Holandia</li>
                    <li><strong>BE</strong> - Belgia</li>
                    <li><strong>CZ</strong> - Czechy</li>
                    <li><strong>AT</strong> - Austria</li>
                    <li><strong>SK</strong> - Słowacja</li>
                </ul>
            </div>
            <div class="col-md-4">
                <ul class="list-unstyled">
                    <li><strong>SI</strong> - Słowenia</li>
                    <li><strong>HU</strong> - Węgry</li>
                    <li><strong>CH</strong> - Szwajcaria</li>
                    <li><strong>GB</strong> - Wielka Brytania</li>
                    <li><strong>DK</strong> - Dania</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    .list-unstyled {
        list-style: none;
        padding-left: 0;
    }
    
    .list-unstyled li {
        margin-bottom: 8px;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }
    
    .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding-right: 15px;
        padding-left: 15px;
    }
    
    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
        padding-right: 15px;
        padding-left: 15px;
    }
    
    .waypoint-group {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .waypoint-group h6 {
        color: #007bff;
        margin: 0;
    }
    
    @media (max-width: 768px) {
        .col-md-4, .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
            margin-bottom: 15px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let waypointCount = 0;
    const maxWaypoints = 5;
    
    const addBtn = document.getElementById('add-waypoint-btn');
    const container = document.getElementById('waypoints-container');
    
    addBtn.addEventListener('click', function() {
        if (waypointCount >= maxWaypoints) {
            alert('Maksymalnie 5 punktów pośrednich');
            return;
        }
        
        waypointCount++;
        
        const waypointDiv = document.createElement('div');
        waypointDiv.className = 'waypoint-group';
        waypointDiv.id = `waypoint-${waypointCount}`;
        waypointDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h6>Punkt pośredni #${waypointCount}</h6>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeWaypoint(${waypointCount})">
                    <i class="fas fa-times"></i> Usuń
                </button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Kraj:</label>
                        <input type="text" name="waypoint_${waypointCount}_country" 
                               class="form-control" placeholder="np. CZ">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Kod pocztowy:</label>
                        <input type="text" name="waypoint_${waypointCount}_postal" 
                               class="form-control" placeholder="np. 11000">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Miasto (opcjonalnie):</label>
                        <input type="text" name="waypoint_${waypointCount}_city" 
                               class="form-control" placeholder="np. Praha">
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(waypointDiv);
        
        // Aktualizuj przycisk
        if (waypointCount >= maxWaypoints) {
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-check-circle"></i> Maksimum punktów osiągnięte';
        }
    });
    
    // Funkcja globalna do usuwania punktów
    window.removeWaypoint = function(id) {
        const element = document.getElementById(`waypoint-${id}`);
        if (element) {
            element.remove();
            waypointCount--;
            
            // Aktualizuj numerację pozostałych punktów
            const remaining = container.querySelectorAll('.waypoint-group');
            remaining.forEach((wp, index) => {
                const h6 = wp.querySelector('h6');
                if (h6) {
                    h6.textContent = `Punkt pośredni #${index + 1}`;
                }
            });
            
            // Odblokuj przycisk
            if (waypointCount < maxWaypoints) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Dodaj punkt pośredni';
            }
        }
    };
});
</script>
{% endblock %}
